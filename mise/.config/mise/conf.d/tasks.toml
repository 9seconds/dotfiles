# vim: ts=2 sts=2 sw=2:

[task_config]
dir = "~"

[tasks."update"]
description = "Update system"
depends = [
  "update:system",
  "update:dotfiles",
  "update:nvim",
  "update:fish",
  "update:mise",
  "update:kitten",
]

[tasks."update:system"]
description = "Run system updates"
depends = [
  "update:system:{{ os() }}"
]

[tasks."update:dotfiles"]
description = "Update dotfiles"
run = [
  "git -C {{ get_env(name='9SECONDS_DOTFILES_DIR', default='~/.dotfiles') }} pull --recurse-submodules --autostash --rebase"
]

[tasks."update:system:linux"]
description = "Run system updates for Linux (assume Ubuntu)"
env = { DEBIAN_FRONTEND = "noninteractive" }
run = [
  "sudo apt update -q",
  "sudo apt full-upgrade --yes",
  "sudo apt autoremove --yes --purge",
]

[tasks."update:system:macos"]
description = "Run system updates for MacOS"
run = [
  "brew update",
  "brew upgrade --greedy-latest",
  "brew autoremove",
  "brew cleanup --prune=all --scrub",
  "rm -rf $(brew --cache)",
]

[tasks."update:nvim"]
description = "Update Neovim"
wait_for = [
  "update:dotfiles"
]
run = "nvim --headless '+Lazy! sync' +qa"

[tasks."update:fish"]
description = "Update fish"
wait_for = [
  "update:dotfiles"
]
run = "fish -ic 'fisher update'"

[tasks."update:mise"]
description = "Update mise"
wait_for = [
  "update:dotfiles"
]
env = { RUSTUP_INIT_SKIP_PATH_CHECK = "1", MISE_YES="1" }
run = [
  "mise self-update 2>/dev/null || true",
  "mise plugins update",
  "mise upgrade",
  "mise prune",
  "mise reshim"
]

[tasks."update:kitten"]
description = "Update kitten"
run = "command -v kitten 2>/dev/null && kitten update-self || true"
