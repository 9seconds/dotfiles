[[env]]
GIT_USERNAME = "9econds"
GIT_REPO_PATH = "{{ config_root }}"

# -----------------------------------------------------------------------------

[tools]
"cargo:selene" = "latest"
"pipx:mypy" = "latest"
ruff = "latest"
stylua = "latest"
python = "latest"

# -----------------------------------------------------------------------------

[tasks."module:ensure"]
description = "Mount module"
alias = "plug"
usage = '''
  arg "<module>" var=#true help="Name of the plug to connect to"
  complete "module" run="ls -l ~/.dotfiles | awk '$1 ~ /^d.*/ {print $NF}'"
'''
wait_for = [
  "module:regenerate"
]
tools.python = "latest"
run = "./dots ensure {{ arg(name='module') }}"

[tasks."module:regenerate"]
description = "Regenerate dots state"
run = [
  "rm -rf {{ [xdg_state_home, '9dots', '*'] | join_path }}",
  "./dots regenerate"
]

[tasks."module:drop"]
description = "Unmount plug"
alias = "unplug"
usage = '''
  arg "<module>" var=#true help="Name of the plug to disconnect"
  complete "module" run="ls -l ~/.dotfiles | awk '$1 ~ /^d.*/ {print $NF}'"
'''
wait_for = [
  "module:regenerate"
]
tools.python = "latest"
run = "./dots drop {{ arg(name='plug') }}"

# ============

[tasks."lua"]
description = "Run Lua routines"
depends = ['lua:*']
sources = [
  ".stylua.toml",
  "selene.toml",
  "**/*.lua"
]

[tasks."lua:format"]
description = "Run all Lua formatters"
depends = ['lua:format:*']
sources = [
  "selene.toml",
  "**/*.lua"
]

[tasks."lua:lint"]
description = "Run all Lua linters"
depends = ['lua:lint:*']
sources = [
  ".stylua.toml",
  "**/*.lua"
]

[tasks."lua:format:stylua"]
description = "Run Stylua"
usage = '''
  arg "<source>" help="Name of the file to process" default="." var=#true
  complete "source" run="fd -e lua -t file -t symlink -H"
'''
run = "stylua -a {{ arg(name='source') }}"

[tasks."lua:lint:selene"]
description = "Run Selene"
usage = '''
  arg "<source>" help="Name of the file to lint" default="." var=#true
  complete "source" run="fd -e lua -t file -t symlink -H"
'''
run = "selene {{ arg(name='source') }}"


# -----------------------------------------------------------------------------
# PYTHON
# -----------------------------------------------------------------------------

[tasks."python"]
description = "Run Python routines"
depends = [
  "python:*",
]

[tasks."python:format"]
description = "Run all Python formatters"
tools.fd = "latest"
depends = [
  "python:format:*"
]

[tasks."python:lint"]
description = "Run all Python linters"
tools.fd = "latest"
wait_for = [
  "python:format:*"
]
depends = [
  "python:lint:*"
]

[tasks."python:lint:ruff"]
description = "Run Ruff (linter)"
tools.ruff = "latest"
tools.fd = "latest"
run = [
  "ruff check dots",
  "fd -e py -t file -H -X ruff check"
]

[tasks."python:lint:mypy"]
description = "Run MyPy"
tools."pipx:mypy" = "latest"
tools.fd = "latest"
run = [
  "mypy dots",
  "fd -e py -t file -H -X mypy"
]

[tasks."python:format:ruff"]
description = "Run Ruff (format)"
tools.ruff = "latest"
tools.fd = "latest"
run = [
  "ruff format dots",
  "fd -e py -t file -H -X ruff format"
]
