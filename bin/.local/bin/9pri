#!/usr/bin/env python3

from __future__ import annotations

import argparse
import logging
import math
import os
import subprocess
import sys
import typing as t

LOG: t.Final[logging.Logger] = logging.getLogger(__name__)


def main() -> None:
    options = get_options()

    if os.geteuid() != 0:
        sys.exit("This script requires root user")

    logging.basicConfig(
        level=logging.DEBUG if options.debug else logging.INFO,
        format=">>> %(message)s",
    )
    LOG.debug("Options: %s", options)

    if not options.command:
        sys.exit("No command specified")

    os.setpgrp()

    priority = math.ceil((10 - options.priority) * 3.9) - 20
    LOG.debug("Priority is %d", priority)
    os.setpriority(os.PRIO_PGRP, 0, priority)

    ionice = math.ceil(options.priority * 0.7)
    LOG.debug("io nice is %d", ionice)

    subprocess.run(  # noqa: S603
        [  # noqa: S607
            "ionice",
            "-c",
            "2",
            "-n",
            str(ionice),
            "-t",
            "-P",
            str(os.getpgrp()),
        ],
        stdin=subprocess.DEVNULL,
        stdout=subprocess.DEVNULL,
        check=True,
        timeout=1,
    )

    os.execlp(options.command[0], *options.command)  # noqa: S606


def get_options() -> argparse.Namespace:
    def type_priority(value: str) -> int:
        ivalue = int(value)
        if ivalue < 0 or ivalue > 10:  # noqa: PLR2004
            raise argparse.ArgumentTypeError(
                f"Priority must be between 0 and 10, got {value}"
            )
        return ivalue

    parser = argparse.ArgumentParser(
        description="Run command with modified priority.",
        epilog="This script requires root user.",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
    )

    parser.add_argument(
        "-d",
        "--debug",
        action="store_true",
        default=False,
        help="Run in debug mode",
    )

    parser.add_argument(
        "priority",
        type=type_priority,
        help="The priority level (0-10). 0 - min, 10 - max",
    )
    parser.add_argument(
        "command",
        nargs=argparse.REMAINDER,
        help="The command to execute",
    )

    return parser.parse_args()


if __name__ == "__main__":
    main()
