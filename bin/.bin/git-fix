#!/usr/bin/env bash
# vim: set ft=bash et ts=2 sw=2 sts=2:
set -eu -o pipefail

#
#  Create a fixup commit for a chosen files
#

# collect files we want to process
FILES=("$@")
if [[ ${#FILES[@]} == 0 ]]; then
  mapfile -t FILES < <(git status --porcelain=v2 \
    | awk '$2 ~ "M." {print $NF}' \
    | fzf --prompt "File> " -m)
fi
if [[ ${#FILES[@]} == 0 ]]; then
  exit 0
fi

# create a file with all outputs
TMPFILE="$(mktemp)"
trap 'rm -f $TMPFILE' EXIT

# now collect all outputs into this file
for file in "${FILES[@]}"; do
  git log \
      --follow \
      --no-merges \
      --date-order \
      --oneline \
      --pretty=tformat:"%h|%cD|%s" \
    -- "$file" >> "$TMPFILE"
done

awk -v "required=${#FILES[@]}" '
    a[$0]++;

    END {
      for (line in a) {
        if (a[line] == required) {
          print(line)
        }
      }
    }' "$TMPFILE" \
  | fzf --no-sort --prompt "Commit> " \
  | awk -F "|" '{print $1}' \
  | xargs -r -I XXX git commit --fixup=XXX
