#!/usr/bin/env bash
# vim: set ft=bash et ts=2 sw=2 sts=2:
set -eu -o pipefail

#
#  Rebase feature branch
#

ARGS=$(getopt \
  -n "git changed" \
  --longoptions "help,base:target:" \
  --options "hb:" \
  -- "$@")
[[ $? -ne 0 ]] && exit 1
eval set -- "$ARGS"

BASE=""

while [ : ]; do
  case "$1" in
    -h | --help)
      echo "Rebase feature branch"
      echo "  -h, --help      Display this help message"
      echo "  -b, --base    * Use this commit as a base"
      exit 0
      ;;
    --)
      shift;
      break
      ;;
    -b | --base)
      BASE="$2"
      shift 2
      ;;
  esac
done

TARGET="${1:-origin/master}"


if ! git diff --quiet HEAD; then
  echo "Repository is dirty" >&2
  exit 1
fi


if [[ $BASE == "" ]]; then
  BASE="$(git merge-base --fork-point "$TARGET")"
fi

read -p "Rebase from $BASE? " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && exit 0

git rebase --interactive --autosquash --autostash --onto "$TARGET" "$BASE"
